---

- name: create logrotate entry for ansible-pull.log
  ansible.builtin.template:
    src: 'etc/logrotate.d/potos-ansible-pull.j2'
    dest: '/etc/logrotate.d/potos-ansible-pull'
    owner: root
    group: root
    mode: 0644

- name: install execution script
  ansible.builtin.template:
    src: 'usr/bin/potos-ansible-pull.j2'
    dest: "/usr/bin/{{ client_name | lower }}-ansible-pull"
    owner: root
    group: root
    mode: 0750

- name: install systemd service files
  ansible.builtin.template:
    src: "etc/systemd/system/potos-ansible-pull@.service.j2"
    dest: "/etc/systemd/system/{{ client_name | lower }}-ansible-pull@.service"
    owner: root
    group: root
    mode: 0644

- name: install systemd timer files
  ansible.builtin.template:
    src: "etc/systemd/system/potos-ansible-pull.timer.j2"
    dest: "/etc/systemd/system/{{ client_name | lower }}-ansible-pull-{{ item.runtype }}.timer"
    owner: root
    group: root
    mode: 0644
  vars:
    runtype: "{{ item.runtype }}"
    onCalendar: "{{ item.onCalendar | default(omit) }}"
  loop: "{{ potos_basics_runtypes | selectattr('runtype', 'defined') | selectattr('onCalendar', 'defined') }}"

- name: enable systemd timer/service
  ansible.builtin.systemd:
    name: "{{ client_name | lower }}-ansible-pull-{{ item }}.timer"
    state: restarted
    enabled: true
    masked: false
    daemon_reload: true
  loop: "{{ potos_basics_runtypes | selectattr('runtype', 'defined') | selectattr('onCalendar', 'defined') | map(attribute='runtype') }}"
  changed_when: false
